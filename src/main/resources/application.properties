# Quarkus Application Configuration

# Application
quarkus.application.name=english-learning

# JWT Authentication Configuration
# MicroProfile JWT Settings
mp.jwt.verify.publickey.algorithm=RS256
mp.jwt.verify.issuer=${JWT_ISSUER:https://auth.englishlearning.com}
# Public key location - can be file path, classpath resource, or JWKS URL
mp.jwt.verify.publickey.location=${JWT_PUBLIC_KEY_LOCATION:META-INF/resources/publicKey.pem}

# SmallRye JWT Configuration
smallrye.jwt.verify.key-format=PEM_KEY
# For reactive applications - use blocking authentication to prevent thread blocking
quarkus.smallrye-jwt.blocking-authentication=true
# Role claim path in JWT (standard is 'groups', but can be customized)
mp.jwt.verify.groups.claim=${JWT_GROUPS_CLAIM:groups}

# Security Configuration
# Allow endpoints without @RolesAllowed to be accessed (we use @Authenticated explicitly)
quarkus.security.jaxrs.deny-unannotated-endpoints=false
# Enable proactive authentication for better reactive performance
quarkus.http.auth.proactive=true

# Development mode - use embedded test public key
%dev.mp.jwt.verify.issuer=https://dev.englishlearning.com
%dev.mp.jwt.verify.publickey.location=META-INF/resources/dev-publicKey.pem

# Test mode - use test security
%test.mp.jwt.verify.issuer=https://test.englishlearning.com
%test.mp.jwt.verify.publickey.location=META-INF/resources/dev-publicKey.pem
%test.quarkus.smallrye-jwt.enabled=true

# Production - use JWKS endpoint from environment
%prod.mp.jwt.verify.publickey.location=${JWT_JWKS_URL}
%prod.mp.jwt.verify.issuer=${JWT_ISSUER}

# HTTP
quarkus.http.port=${HTTP_PORT:8080}

# Reactive PostgreSQL - Use environment variables for cloud-native deployments
quarkus.datasource.db-kind=postgresql
quarkus.datasource.username=${DB_USERNAME:postgres}
quarkus.datasource.password=${DB_PASSWORD:postgres}

# Database URLs - Set for dev profile (prod URLs are set below in prod section)
# NOTE: URLs are NOT set for test profile to allow Dev Services to auto-configure
%dev.quarkus.datasource.reactive.url=postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:english_learning}
%dev.quarkus.datasource.jdbc.url=jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:english_learning}

# Flyway
quarkus.flyway.migrate-at-start=true
quarkus.flyway.locations=db/migration

# Hibernate Reactive
quarkus.hibernate-orm.database.generation=none
quarkus.hibernate-orm.log.sql=true

# Jackson
quarkus.jackson.serialization-inclusion=non-null

# Qute Template Engine Configuration
# Strict rendering mode - fails on undefined variables/properties
quarkus.qute.strict-rendering=true
# Remove standalone lines (better HTML formatting)
quarkus.qute.remove-standalone-lines=true
# Property not found strategy: throw exception in dev/test, output original expression in prod
quarkus.qute.property-not-found-strategy=throw-exception
# Timeout for async template rendering (in milliseconds)
quarkus.qute.timeout=10000
# Enable type-safe validation at build time
quarkus.qute.type-check-exclude=

# Development mode - hot reload templates
%dev.quarkus.qute.dev-mode.check-interval=1s
# In dev mode, output original expression instead of failing
%dev.quarkus.qute.property-not-found-strategy=output-original

# Production - strict mode for safety
%prod.quarkus.qute.strict-rendering=true
%prod.quarkus.qute.property-not-found-strategy=throw-exception

# Dev Services (for development)
%dev.quarkus.datasource.devservices.enabled=true
%dev.quarkus.datasource.devservices.image-name=postgres:16

# Test - Dev Services configuration
%test.quarkus.datasource.devservices.enabled=true
%test.quarkus.datasource.devservices.image-name=postgres:16
# Disable SQL logging for faster test execution
%test.quarkus.hibernate-orm.log.sql=false
# Disable observability for tests
%test.quarkus.otel.enabled=false
%test.quarkus.micrometer.enabled=false

# Production - Cloud-Native Configuration
%prod.quarkus.datasource.username=${DB_USERNAME}
%prod.quarkus.datasource.password=${DB_PASSWORD}
%prod.quarkus.datasource.reactive.url=postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
%prod.quarkus.datasource.jdbc.url=jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
%prod.quarkus.hibernate-orm.log.sql=false
%prod.quarkus.log.level=INFO
%prod.quarkus.log.min-level=INFO

# Staging - Similar to production but with more logging
%staging.quarkus.datasource.username=${DB_USERNAME}
%staging.quarkus.datasource.password=${DB_PASSWORD}
%staging.quarkus.datasource.reactive.url=postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
%staging.quarkus.datasource.jdbc.url=jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
%staging.quarkus.hibernate-orm.log.sql=false
%staging.quarkus.log.level=DEBUG

# Observability - Metrics (Micrometer Prometheus)
quarkus.micrometer.enabled=true
quarkus.micrometer.export.prometheus.enabled=true
quarkus.micrometer.export.prometheus.path=/metrics
quarkus.micrometer.binder.http-server.enabled=true
quarkus.micrometer.binder.http-client.enabled=true
quarkus.micrometer.binder.jvm.enabled=true
quarkus.micrometer.binder.system.enabled=true
# Database metrics
quarkus.datasource.metrics.enabled=true
# Reactive metrics
quarkus.micrometer.binder.vertx.enabled=true

# Observability - Distributed Tracing (OpenTelemetry)
quarkus.otel.enabled=true
quarkus.otel.traces.enabled=true
quarkus.otel.metrics.enabled=true
# Service name for tracing (uses application.name defined at top)
quarkus.otel.service.name=english-learning
# Sampler configuration (sample all traces in dev, 10% in prod)
%dev.quarkus.otel.traces.sampler=always_on
%prod.quarkus.otel.traces.sampler=traceidratio
%prod.quarkus.otel.traces.sampler.arg=0.1
# OTLP exporter endpoint (configure per environment)
quarkus.otel.exporter.otlp.endpoint=${OTEL_EXPORTER_ENDPOINT:http://localhost:4317}
%prod.quarkus.otel.exporter.otlp.endpoint=${OTEL_EXPORTER_ENDPOINT}

# Graceful Shutdown for Cloud Environments
# Allow in-flight requests to complete before shutdown
quarkus.shutdown.timeout=30s
# Reactive timeout for async operations
quarkus.reactive-timeout=60s
# Database connection pool settings for cloud
quarkus.datasource.reactive.max-size=${DB_POOL_MAX_SIZE:20}
quarkus.datasource.reactive.idle-timeout=PT10M
quarkus.datasource.reactive.acquisition-timeout=PT10S
